CREATE TYPE vertex_type
	AS ENUM('player', 'team', 'game');

CREATE TABLE vertices(
identifier TEXT,
type vertex_type,
properties JSON,
PRIMARY KEY(identifier, type)
);

CREATE TYPE edge_type 
	AS ENUM('plays_against', 'shares_team', 'plays_in', 'plays_on');

CREATE TABLE edges(
subject_identifier TEXT,
subject_type vertex_type,
object_identifier TEXT,
object_type vertex_type,
edge_type edge_type,
properties JSON,
PRIMARY KEY(subject_identifier, subject_type, object_identifier, object_type, edge_type)
);

INSERT INTO vertices(
	SELECT 
		game_id AS indentifier,
		'game' :: vertex_type AS vertex_type,
		json_build_object(
			'pts_home', pts_home,
			'pts_away', pts_away,
			'winning_team', CASE WHEN home_team_wins = 1 THEN home_team_id ELSE visitor_team_id END
		) AS properties
	FROM 
		games
);

INSERT INTO vertices(
	SELECT 
		player_id AS identifier,
		'player' :: vertex_type AS vertex_type,
		json_build_object(
			'player_name', MAX(player_name),
			'num_of_games', COUNT(1),
			'total_points', SUM(pts),
			'teams', ARRAY_AGG(DISTINCT team_id)
		) AS properties
	FROM
		game_details
	GROUP BY
		player_id
);

INSERT INTO vertices(
	WITH teams_deduped AS (
	SELECT
		*,
		ROW_NUMBER () OVER(PARTITION BY team_id ORDER BY team_id) AS row_nm
	FROM
		teams
	)
	SELECT
		team_id AS identifier,
		'team' :: vertex_type AS type,
		json_build_object(
			'abbreviation', abbreviation,
			'nickname', nickname,
			'city', city,
			'arena', arena,
			'year_founded', yearfounded
		) AS properties
	FROM
		teams_deduped
	WHERE
		row_nm = 1
);

INSERT INTO edges(
	WITH games_deduped AS(
		SELECT 
			*,
			ROW_NUMBER() OVER(PARTITION BY game_id, player_id ORDER BY game_id, player_id) AS row_nm
		FROM
			game_details
	)
	SELECT
		player_id AS subject_identifier,
		'player' :: vertex_type AS subject_type,
		game_id AS object_identifier,
		'game' :: vertex_type AS object_type,
		'plays_in' :: edge_type AS edge_type,
		json_build_object(
			'start_position', start_position,
			'pts', pts,
			'team_id', team_id,
			'team_abbreviation', team_abbreviation
		) AS properties
	FROM 
		games_deduped
	WHERE
		row_nm = 1
);

INSERT INTO edges(
	WITH game_details_numbered AS (
		SELECT 
			*,
			ROW_NUMBER() OVER(PARTITION BY game_id, player_id) AS row_nm
		FROM
			game_details
	),
	game_details_deduped AS (
		SELECT * FROM game_details_numbered
		WHERE row_nm = 1
	),
	aggregated AS (
		SELECT
			g1.player_id AS subject_identifier,
			'player' :: vertex_type AS subject_type,
			g2.player_id AS object_identifier,
			'player' :: vertex_type AS object_type,
			CASE WHEN MAX(g1.team_id) = MAX(g2.team_id) THEN 'shares_team' :: edge_type ELSE 'plays_against' :: edge_type END AS edge_type,
			json_build_object(
				'left_pts', SUM(g1.pts),
				'right_pts', SUM(g2.pts),
				'num_games', COUNT(1)
			) AS properties
		FROM
			game_details_deduped g1
		JOIN
			game_details_deduped g2
		ON
			g1.game_id = g2.game_id
			AND
			g1.player_id > g2.player_id
		GROUP BY
			g1.player_id,
			g2.player_id
	)
	SELECT * FROM aggregated
);

SELECT 
	v1.properties ->> 'player_name' AS left_name,
	CAST(v1.properties ->> 'total_points' AS REAL) / CASE WHEN CAST(v1.properties ->> 'num_of_games' AS INT) = 0 THEN 1 ELSE CAST(v1.properties ->> 'num_of_games' AS INT) END AS left_global_average,
	CAST(e.properties ->> 'left_pts' AS REAL) / CASE WHEN CAST(e.properties ->> 'num_games' AS INT) = 0 THEN 1 ELSE CAST(e.properties ->> 'num_games' AS INT) END AS left_local_average,
	v2.properties ->> 'player_name' AS right_name,
	CAST(v2.properties ->> 'total_points' AS REAL) / CASE WHEN CAST(v2.properties ->> 'num_of_games' AS INT) = 0 THEN 1 ELSE CAST(v2.properties ->> 'num_of_games' AS INT) END AS right_global_average,
	CAST(e.properties ->> 'right_pts' AS REAL) / CASE WHEN CAST(e.properties ->> 'num_games' AS INT) = 0 THEN 1 ELSE CAST(e.properties ->> 'num_games' AS INT) END AS right_local_average
FROM
	edges e
JOIN
	vertices v1
ON
	e.subject_identifier = v1.identifier
	AND
	e.subject_type = v1.type
JOIN
	vertices v2
ON 
	e.object_identifier = v2.identifier
	AND
	e.object_type = v2.type
WHERE 
	e.subject_type = 'player' 
	AND 
	e.object_type = 'player'